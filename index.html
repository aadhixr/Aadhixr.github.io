<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Beehive Monitor - Live</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="favicon.jpg" type="image/jpeg"> <meta name="theme-color" content="#2d3e50"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script> <style>
    /* Your existing CSS styles */
    :root {
      --bg: #f9fbff; --fg: #333;
      --card: #fff; --buttonBg: #2d3e50; --buttonFg: #fff;
      --chartText: #333;
    }
    .dark {
      --bg: #2b2e3b; --fg: #ddd;
      --card: #3a3f4b; --buttonBg: #ddd; --buttonFg: #2d3e50;
    }

    /* Added styles for notification section */
    .notification-section {
      text-align: center;
      margin: 20px 0;
      padding: 15px;
      background-color: var(--card);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .notification-section h3 {
      margin-top: 0;
      color: var(--fg);
    }
    .notification-section button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      background-color: var(--buttonBg);
      color: var(--buttonFg);
    }
    #notificationStatus {
      margin-top: 10px;
      font-size: 0.9em;
      color: var(--fg);
    }
  </style>
</head>
<body>
  <header>
    <div class="header-container">
      <img src="favicon.jpg" alt="Beehive Icon" class="header-icon">
      <h1>Beehive Monitor</h1>
      <div class="header-links">
        <a href="index.html" class="active">Live</a>
        <a href="history.html">History</a>
      </div>
      <button id="themeToggle" class="theme-toggle-button">ðŸŒ™</button>
    </div>
  </header>

  <main>
    <div class="loader-container" id="loader">
      <div class="loader"></div>
      <p>Loading data...</p>
    </div>

    <div class="cards-container">
      <div class="card temp-card">
        <h3>Temperature</h3>
        <p><span id="temperature">--</span></p>
      </div>
      <div class="card hum-card">
        <h3>Humidity</h3>
        <p><span id="humidity">--</span></p>
      </div>
      <div class="card air-card">
        <h3>Air Quality</h3>
        <p><span id="air_quality">--</span></p>
      </div>
    </div>

    <div class="notification-section">
      <h3>Notifications</h3>
      <button id="enableNotificationsBtn">Enable Push Notifications</button>
      <div id="notificationStatus"></div>
      <button id="disableNotificationsBtn" style="display: none;">Disable Notifications</button>
    </div>

    <audio id="alertSound" src="alert.mp3" preload="auto"></audio> <div class="chart-container">
      <canvas id="myChart"></canvas>
    </div>
  </main>

  <script>
    // Your Firebase project configuration - NOW WITH YOUR ACTUAL VALUES
    const firebaseConfig = {
      apiKey: "AIzaSyD4M_ZOMqR9MtSkbgH2SQQvj2QSAFKLOhU",
      authDomain: "beehive-d31e3.firebaseapp.com",
      databaseURL: "https://beehive-d31e3-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "beehive-d31e3",
      storageBucket: "beehive-d31e3.firebasestorage.app",
      messagingSenderId: "412298384436",
      appId: "1:412298384436:web:469569b024f27482456661",
      measurementId: "G-P6FF4EJC3K"
    };

    const VAPID_KEY = 'BHvNg-KsFy9jorhmTVYw-3vOZZdneUH-e-z8NhwYlPFg'; // Your provided VAPID Key

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const messaging = firebase.messaging(); // Initialize messaging service
    const alertSound = document.getElementById('alertSound'); // Get audio element

    // --- PWA Service Worker Registration ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          })
          .catch(error => {
            console.log('ServiceWorker registration failed: ', error);
          });
      });
    }

    // --- FCM Notification Logic ---
    const enableNotificationsBtn = document.getElementById('enableNotificationsBtn');
    const disableNotificationsBtn = document.getElementById('disableNotificationsBtn');
    const notificationStatusDiv = document.getElementById('notificationStatus');

    function updateNotificationButtonStatus() {
      if (!('Notification' in window) || !('serviceWorker' in navigator) || !firebase.messaging.isSupported()) {
        notificationStatusDiv.textContent = 'Notifications are not supported by your browser/device.';
        enableNotificationsBtn.style.display = 'none';
        disableNotificationsBtn.style.display = 'none';
        return;
      }

      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          notificationStatusDiv.textContent = 'Notifications are currently enabled.';
          enableNotificationsBtn.style.display = 'none';
          disableNotificationsBtn.style.display = 'inline-block';
        } else if (permission === 'denied') {
          notificationStatusDiv.textContent = 'Notifications are blocked. Please enable them in browser settings.';
          enableNotificationsBtn.style.display = 'none';
          disableNotificationsBtn.style.display = 'none'; // Cannot re-enable programmatically
        } else { // 'default'
          notificationStatusDiv.textContent = 'Notifications are not enabled.';
          enableNotificationsBtn.style.display = 'inline-block';
          disableNotificationsBtn.style.display = 'none';
        }
      }).catch(error => {
          console.error("Error checking notification permission:", error);
          notificationStatusDiv.textContent = 'Error checking notification status.';
      });
    }

    // Request permission and get token
    enableNotificationsBtn.addEventListener('click', () => {
      Notification.requestPermission().then((permission) => {
        if (permission === 'granted') {
          notificationStatusDiv.textContent = 'Notification permission granted. Getting token...';
          messaging.getToken({ vapidKey: VAPID_KEY }) // Use the VAPID_KEY constant
            .then((currentToken) => {
              if (currentToken) {
                console.log('FCM Registration Token:', currentToken);
                notificationStatusDiv.textContent = 'Notifications enabled.';
                // Save token to Firebase Realtime Database
                // We'll store it under /fcmTokens/ with the token as the key
                // Replace invalid Firebase key characters (., #, $, /, [, ])
                const sanitizedToken = currentToken.replace(/[.#$[\]]/g, '_');
                database.ref('/fcmTokens/' + sanitizedToken).set(true)
                  .then(() => {
                    console.log('Token successfully stored in Firebase DB.');
                    updateNotificationButtonStatus();
                  })
                  .catch((error) => {
                    console.error('Error storing token in Firebase DB:', error);
                    notificationStatusDiv.textContent = 'Error storing token.';
                  });
              } else {
                console.warn('No registration token available. Request permission to generate one.');
                notificationStatusDiv.textContent = 'No token available.';
                updateNotificationButtonStatus();
              }
            })
            .catch((err) => {
              console.error('An error occurred while retrieving token. ', err);
              notificationStatusDiv.textContent = 'Error getting token.';
              updateNotificationButtonStatus();
            });
        } else {
          console.warn('Unable to get permission to notify.');
          notificationStatusDiv.textContent = 'Notification permission denied.';
          updateNotificationButtonStatus();
        }
      });
    });

    // Delete token and disable notifications
    disableNotificationsBtn.addEventListener('click', () => {
      if (messaging) {
        messaging.getToken()
          .then((currentToken) => {
            if (currentToken) {
              // Delete the token from Firebase Messaging
              return messaging.deleteToken(currentToken);
            }
            return Promise.resolve(); // No token to delete
          })
          .then(() => {
            // Also remove from your database
            // Note: If getToken() was null, currentToken would be null, so check again.
            // Using messaging.getToken() can return a promise, so use async/await or .then
            return messaging.getToken().then(tokenToDelete => {
                if (tokenToDelete) {
                    const sanitizedToken = tokenToDelete.replace(/[.#$[\]]/g, '_');
                    return database.ref('/fcmTokens/' + sanitizedToken).remove();
                }
                return Promise.resolve();
            });
          })
          .then(() => {
            console.log('Token deleted.');
            notificationStatusDiv.textContent = 'Notifications disabled.';
            updateNotificationButtonStatus();
          })
          .catch((err) => {
            console.error('Error disabling notifications: ', err);
            notificationStatusDiv.textContent = 'Error disabling notifications.';
          });
      }
    });

    // Handle incoming messages while the app is in the foreground
    // This will NOT trigger system notifications but allows you to handle them
    messaging.onMessage((payload) => {
      console.log('Message received in foreground. ', payload);
      // Play sound
      if (alertSound) {
          alertSound.play().catch(e => console.error("Error playing sound:", e));
      }
      // Optionally display a custom in-app notification/banner
      alert(`Alert: ${payload.notification.title}\n${payload.notification.body}`);
    });

    // Initial check for notification status on page load
    updateNotificationButtonStatus();


    // --- Your existing live data update logic (from your original HTML) ---
    const temperatureEl = document.getElementById('temperature');
    const humidityEl = document.getElementById('humidity');
    const airQualityEl = document.getElementById('air_quality');
    const lastTimeEl = document.getElementById('last_time');
    const loaderEl = document.getElementById('loader');

    const currentLiveRef = database.ref('/beehive');
    currentLiveRef.on('value', (snapshot) => {
      const data = snapshot.val();
      if (data) {
        temperatureEl.textContent = data.temperature ? data.temperature.toFixed(2) + ' Â°C' : '--';
        humidityEl.textContent = data.humidity ? data.humidity.toFixed(2) + ' %' : '--';
        airQualityEl.textContent = data.air_quality ? data.air_quality.toFixed(0) + ' %' : '--';
        lastTimeEl.textContent = data.last_time || '--';
        if (loaderEl) loaderEl.style.display = 'none';
      } else {
        temperatureEl.textContent = '--';
        humidityEl.textContent = '--';
        airQualityEl.textContent = '--';
        lastTimeEl.textContent = '--';
        if (loaderEl) loaderEl.style.display = 'none';
      }
    }, (error) => {
      console.error("Error fetching live data:", error);
      if (loaderEl) loaderEl.style.display = 'none';
    });

    // --- Your existing chart.js and history logic (not fully provided but assuming it's here) ---
    // Make sure your loadHistoryData, createChart, etc. functions are defined here.
    // This example assumes they are defined globally or within this script scope.

    // Example of theme toggle function if you have one
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            // Re-render chart if theme affects it
            // if (myChart) {
            //     myChart.options.scales.x.ticks.color = isDark ? '#ddd' : '#333';
            //     myChart.options.scales.y.ticks.color = isDark ? '#ddd' : '#333';
            //     myChart.update();
            // }
        });
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark');
        }
    }

  </script>
</body>
</html>
