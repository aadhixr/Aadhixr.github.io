<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Beehive Monitor - History</title>
  <meta name="theme-color" content="#2d3e50"/>
  <link rel="icon" href="favicon.jpg" type="image/jpeg">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script> <style>
    /* Your existing styles */
  </style>
</head>
<body>
  <header>
    <div class="header-container">
      <img src="favicon.jpg" alt="Beehive Icon" class="header-icon">
      <h1>Beehive Monitor</h1>
      <div class="header-links">
        <a href="index.html">Live</a>
        <a href="history.html" class="active">History</a>
      </div>
      <button id="themeToggle" class="theme-toggle-button">ðŸŒ™</button>
    </div>
  </header>

  <main>
    <div class="loader-container" id="loader">
      <div class="loader"></div>
      <p>Loading data...</p>
    </div>

    <div class="chart-controls">
      <select id="dataType">
        <option value="temperature">Temperature</option>
        <option value="humidity">Humidity</option>
        <option value="air_quality">Air Quality</option>
      </select>
      <select id="dateRange">
        <option value="1h">Last Hour</option>
        <option value="24h">Last 24 Hours</option>
        <option value="7d">Last 7 Days</option>
        <option value="30d">Last 30 Days</option>
      </select>
    </div>
    <div class="chart-container">
      <canvas id="historyChart"></canvas>
    </div>
  </main>

  <script>
    // Your Firebase project configuration - NOW WITH YOUR ACTUAL VALUES
    const firebaseConfig = {
      apiKey: "AIzaSyD4M_ZOMqR9MtSkbgH2SQQvj2QSAFKLOhU",
      authDomain: "beehive-d31e3.firebaseapp.com",
      databaseURL: "https://beehive-d31e3-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "beehive-d31e3",
      storageBucket: "beehive-d31e3.firebasestorage.app",
      messagingSenderId: "412298384436",
      appId: "1:412298384436:web:469569b024f27482456661",
      measurementId: "G-P6FF4EJC3K"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    // No need to initialize messaging here unless you specifically want FCM features on this page

    // --- Your existing Chart.js and history data loading logic ---
    const loaderEl = document.getElementById('loader');
    const dataTypeSelect = document.getElementById('dataType');
    const dateRangeSelect = document.getElementById('dateRange');
    const historyChartCanvas = document.getElementById('historyChart');
    let myHistoryChart; // To hold the Chart.js instance

    // Function to get chart options (assuming this is already defined in your app)
    function getChartOptions(range, tooltipLabels) {
        // ... your existing getChartOptions logic ...
        // Example placeholder:
        return {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return tooltipLabels[context[0].dataIndex];
                        }
                    }
                },
                zoom: {
                    zoom: {
                        wheel: { enabled: true },
                        pinch: { enabled: true },
                        mode: 'x',
                    },
                    pan: {
                        enabled: true,
                        mode: 'x'
                    }
                }
            },
            scales: {
                x: {
                    type: 'category',
                    ticks: {
                        color: document.body.classList.contains('dark') ? '#ddd' : '#333'
                    }
                },
                y: {
                    ticks: {
                        color: document.body.classList.contains('dark') ? '#ddd' : '#333'
                    }
                }
            }
        };
    }


    function createChart(labels, temps, hums, airs, fullLabels) {
        if (myHistoryChart) {
            myHistoryChart.destroy();
        }

        const selectedDataType = dataTypeSelect.value;
        let dataPoints = [];
        let labelText = '';
        let borderColor = '';

        if (selectedDataType === 'temperature') {
            dataPoints = temps;
            labelText = 'Temperature (Â°C)';
            borderColor = '#FF6384';
        } else if (selectedDataType === 'humidity') {
            dataPoints = hums;
            labelText = 'Humidity (%)';
            borderColor = '#36A2EB';
        } else if (selectedDataType === 'air_quality') {
            dataPoints = airs;
            labelText = 'Air Quality (%)';
            borderColor = '#FFCE56';
        }

        myHistoryChart = new Chart(historyChartCanvas, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: labelText,
                    data: dataPoints,
                    borderColor: borderColor,
                    tension: 0.1,
                    fill: false
                }]
            },
            options: getChartOptions(dateRangeSelect.value, fullLabels) // Pass range and fullLabels
        });
    }

    function loadData(range) {
        loaderEl.style.display = 'flex';
        let startTime;
        const now = new Date();

        if (range === '1h') {
            startTime = new Date(now.getTime() - 60 * 60 * 1000);
        } else if (range === '24h') {
            startTime = new Date(now.getTime() - 24 * 60 * 60 * 1000);
        } else if (range === '7d') {
            startTime = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        } else if (range === '30d') {
            startTime = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        } else { // Default to 24h if no valid range
            startTime = new Date(now.getTime() - 24 * 60 * 60 * 1000);
        }

        const startTimestamp = startTime.toISOString().replace(/[:.]/g, '-'); // Format for Firebase key
        const endTimestamp = now.toISOString().replace(/[:.]/g, '-');

        database.ref('/history/')
            .orderByKey()
            .startAt(startTimestamp)
            .endAt(endTimestamp)
            .once('value', (snapshot) => {
                const data = snapshot.val();
                const labels = [];
                const temps = [];
                const hums = [];
                const airs = [];
                const fullLabels = [];
                const shownDates = new Set();

                if (data) {
                    Object.keys(data).sort().forEach(key => {
                        const v = data[key];
                        const d = new Date(key.replace(/-/g, ':').replace('T', ' ')); // Convert back to readable date
                        const hour = d.getHours().toString().padStart(2, '0');
                        const min = d.getMinutes().toString().padStart(2, '0');
                        const time = `${hour}:${min}`;
                        const date = `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}`;
                        const full = `${date} ${time}`;
                        let label = '';

                        // Logic for labels on X-axis (similar to your existing HTML)
                        if (range === '1h' || range === '24h') {
                            if (min === '00' || (range === '1h' && ['15', '30', '45'].includes(min))) {
                                label = time;
                            }
                        } else { // 7d, 30d
                            if (!shownDates.has(date)) {
                                label = date;
                                shownDates.add(date);
                            }
                        }

                        labels.push(label);
                        temps.push(v.temperature);
                        hums.push(v.humidity);
                        airs.push(v.air_quality);
                        fullLabels.push(full);
                    });
                }

                createChart(labels, temps, hums, airs, fullLabels);
                loaderEl.style.display = 'none';
            }).catch(err => {
                console.error("Error loading history:", err);
                loaderEl.style.display = 'none';
            });
    }

    // Event listeners for data type and range changes
    dataTypeSelect.addEventListener('change', () => loadData(dateRangeSelect.value));
    dateRangeSelect.addEventListener('change', () => loadData(dateRangeSelect.value));


    // Initial load for the history page
    loadData(dateRangeSelect.value); // Load data based on default selection

    // Theme toggle (copy from index.html if you want it here too)
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            // Update chart colors if theme changes
            if (myHistoryChart) {
                myHistoryChart.options.scales.x.ticks.color = isDark ? '#ddd' : '#333';
                myHistoryChart.options.scales.y.ticks.color = isDark ? '#ddd' : '#333';
                myHistoryChart.update();
            }
        });
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark');
        }
    }

  </script>
</body>
</html>
